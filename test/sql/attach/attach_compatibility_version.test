# name: test/sql/attach/attach_compatibility_version.test
# description: Tests attaching database files with different block allocation sizes.
# group: [attach]

require skip_reload

statement ok
PRAGMA enable_verification

statement ok
ATTACH '__TEST_DIR__/version1_1_0.db' (COMPATIBILITY_VERSION 'v1.1.0');

statement ok
DETACH version1_1_0

statement error
ATTACH '__TEST_DIR__/version1_1_0.db' (COMPATIBILITY_VERSION 'v1.2.0');
----
Invalid Input Error: compatibility_version parameter does not match the file's compatibility_version

# 1.0.0 and 1.1.3 have the same underlying version
statement ok
ATTACH '__TEST_DIR__/version1_1_0.db' (COMPATIBILITY_VERSION 'v1.1.3');

statement ok
DETACH version1_1_0

statement ok
ATTACH '__TEST_DIR__/version_default.db';

statement ok
DETACH version_default

# 0.10.0 is the current default
statement ok
ATTACH '__TEST_DIR__/version_default.db' (COMPATIBILITY_VERSION 'v0.10.0');

statement ok
DETACH version_default

# 0.10.0 is the current default, that has same version as 0.10.2
statement ok
ATTACH '__TEST_DIR__/version_default.db' (COMPATIBILITY_VERSION 'v0.10.2');

statement ok
DETACH version_default

statement ok
ATTACH '__TEST_DIR__/version_from_the_future.db' (COMPATIBILITY_VERSION 'v100.0.0');

statement ok
DETACH version_from_the_future

# 1.2.0 is the current upcoming version
statement ok
ATTACH '__TEST_DIR__/version_from_the_future.db' (COMPATIBILITY_VERSION 'v1.2.0');

statement ok
ATTACH 'data/storage/block_size_16kb.db' (COMPATIBILITY_VERSION 'v0.10.0');

statement ok
DETACH block_size_16kb

statement ok
ATTACH 'data/storage/block_size_16kb.db' (COMPATIBILITY_VERSION 'v0.10.0');

statement ok
DETACH block_size_16kb

statement error
ATTACH 'data/storage/block_size_16kb.db' (COMPATIBILITY_VERSION 'v1.0.0');
----
Invalid Input Error: compatibility_version parameter does not match the file's compatibility_version
